# core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Optional: Setting up to authenticate with Vertex AI

If you already have the vertexauth “superkey.json”, then you may skip
this section and proceed to *Authenticating to Claudette*.

Otherwise, this is example code to create a Google Cloud (GC) Service
Account, and from there create a GC Service Account Key file, and from
there create a vertexauth superkey.json

### 1. Creating a GC service account

``` python
# !pip install -q google-cloud-service-usage google-cloud-iam google-cloud-resource-manager
```

1.  We’ll need to use the `google.cloud.iam_admin_v1` client library
2.  The documentation notes that we’ll need:
    - project_id: The Google Cloud project ID
    - account: The service account ID or email

``` python
import google.auth
from google.cloud import iam_admin_v1
from google.cloud.iam_admin_v1 import types
from google.cloud import resourcemanager_v3
from google.iam.v1 import policy_pb2
```

We can work with Google’s IAM API by using a client, assuming you have
first run `gcloud auth application-default login`.

``` python
project_id = 'jph001'
```

``` python
cli = iam_admin_v1.IAMClient()
credentials, project_id = google.auth.default()
project = f"projects/{project_id}"
project
```

    'projects/jph001'

We will need a “service account” with the appropriate permissions. You
can check your account list like so:

``` python
accounts = cli.list_service_accounts(name = project)
# accounts
```

…and here is how to create an account:

``` python
account_id="aiservice2"
display_name="Vertex AI Service Account 2"
description="Access Vertex AI"
```

``` python
svc = dict(display_name=display_name, description=description)
account = cli.create_service_account(name=project, account_id=account_id, service_account=svc)
# account
```

``` python
polcli = resourcemanager_v3.ProjectsClient()
policy = polcli.get_iam_policy(resource=project)
```

``` python
member = f"serviceAccount:{account.email}"
roles = [ "roles/aiplatform.user", "roles/servicemanagement.quotaViewer", "roles/servicemanagement.quotaAdmin" ]
```

``` python
for role in roles:
    binding = policy_pb2.Binding()
    binding.role = role
    binding.members.append(member)
    policy.bindings.append(binding)
    
polres = polcli.set_iam_policy(request={"resource": project, "policy": policy})
```

(If you later wanted to delete a service account, you could the
following:)

``` python
# cli.delete_service_account(name=f"projects/{project_id}/serviceAccounts/aiservice@jph001.iam.gserviceaccount.com")
```

### 2. Creating a GC Service Account Key File (SAKF)

``` python
key = cli.create_service_account_key(name = f"projects/{project_id}/serviceAccounts/{account.email}")
```

``` python
keyd = json.loads(key.private_key_data.decode())
keyb = json.dumps(keyd).encode()
```

``` python
path = Path('service-account-key.json')
path.write_bytes(keyb)
```

    2329

### 3. Creating a vertexauth “superkey”

A vertexauth “superkey” is merely a SAKF file with a “region” key/value
pair added so that it can be the only resource needed in order to use
this library.

If a colleague already gave you a superkey, save it in
`~/.config/vertexauth/default/superkey.json`, and skip to the next
section *Authenticating to Claudette*. But if you only have a SAKF JSON
file, as created above or downloaded from the Google Cloud web UI, then
you create and save a superkey as follows:

``` python
def save_superkey_file(SAKF_path, region) -> Path:
    d = json.loads(Path(SAKF_path).read_text())
    d["region"] = region
    SUPERKEY_DEFAULT_PATH.parent.mkdir(parents=True,exist_ok=True)
    SUPERKEY_DEFAULT_PATH.write_text(json.dumps(d))
    SUPERKEY_DEFAULT_PATH.chmod(0o600)
    return SUPERKEY_DEFAULT_PATH
```

Save a superkey based on the path of the service account key we just
created above and saved in `path`.

``` python
save_superkey_file(path,'us-east5')
```

    Path('/Users/alexis/.config/vertexauth/default/superkey.json')

## Authenticating to Claudette

Once you have a superkey file (i.e., a JSON SAKF plus a region key/value
pair), then you can use these functions to create a claudette client or
an Anthropic client.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/vertexauth/blob/main/vertexauth/core.py#L29"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_claudette_client

>  get_claudette_client (vertex_model='claude-3-5-sonnet-v2@20241022',
>                            asink=False, anthropic_kwargs=None)

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/vertexauth/blob/main/vertexauth/core.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_anthropic_client

>  get_anthropic_client (asink=False, anthropic_kwargs=None)

## Using claudette

``` python
cl = get_claudette_client()
```

``` python
cl('hi')
```

Hello! How can I help you today?

<details>

- id: `msg_vrtx_013ZqSR5aJtQ1W6XkgsQ1FHP`
- content:
  `[{'text': 'Hello! How can I help you today?', 'type': 'text'}]`
- model: `claude-3-5-sonnet-v2-20241022`
- role: `assistant`
- stop_reason: `end_turn`
- stop_sequence: `None`
- type: `message`
- usage: `{'input_tokens': 8, 'output_tokens': 12}`

</details>

## Todo: quota management

``` python
quota_docs = read_gist('https://gist.github.com/jph00/943c51623abfe0deae65cfad2d821169')
svcuse_docs = read_gist('https://gist.github.com/jph00/042580724e98ae0cce2db50de92abd1b')
```

``` python
from google.cloud import service_usage_v1
```

Yes I see some options we could use – do you want me to outline them
now?

``` python
scli = service_usage_v1.ServiceUsageClient()
services = scli.list_services(request={"parent": project, "filter":"state:ENABLED"})
```
